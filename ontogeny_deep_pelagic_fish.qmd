---
title: "Ontogeny of deep pelagic fish"
format: 
  html:
    self-contained: false
    code-fold: true
editor: source
theme: minty
keep-md: true
execute:
  warning: false
  message : false
toc: true
toc-title: Sections
toc-location: left
page-layout: full
---

# 1. Size distribution as a function of depth

## Density plot by depth layer - community level

-   Bigger fish at depth ?

```{r}
#| echo: false
#| fig-height: 7
#| fig-width: 7

library(tidyr)
library(ggplot2)

#paletteer::paletteer_d("jcolors::pal10")

size_distribution_complete <- utils::read.csv(here::here("data", "size_distribution_complete.csv"), sep = ";", header = T,dec = ".")

large_dataset <- subset(size_distribution_complete, dataset == "Total")

large_dataset$depth_layer <- factor(large_dataset$depth_layer, 
                                  levels = c("epipelagic","upper_mesopelagic",
                                         "lower_mesopelagic","bathypelagic"),
                                  labels = c("Epipelagic","Upper mesopelagic",
                                          "Lower mesopelagic","Bathypelagic"))

df3 <- large_dataset%>%
  dplyr::group_by(depth_layer) %>%
  dplyr::summarise(median_sl = median(size))

ggplot(large_dataset, aes(x=size)) +
  geom_density(alpha=0.3, linewidth=1, aes(col=depth_layer, fill= depth_layer))+
  #geom_histogram(aes(y=..density.., col=depth_layer, fill= depth_layer), alpha=0.3, 
  #               position="identity", binwidth = 1)+
  paletteer::scale_color_paletteer_d("jcolors::pal10")+
  paletteer::scale_fill_paletteer_d("jcolors::pal10")+
  facet_wrap(~depth_layer, ncol=1, scales = "free_y") +
  theme_minimal()+
  scale_x_continuous(trans = 'log2') +
  theme(strip.text.x = element_text(size=12,face="bold"),
        strip.text.y = element_text(size=12),
        axis.title = element_text(size=12),
        axis.text =  element_text(size=12, color= "grey50"),
        panel.background=element_rect(color="white"),
        legend.title = element_text(size=12),
        legend.text = element_text(size=12))+
  geom_vline(data = df3, aes(xintercept = median_sl, col= depth_layer), size= 1, 
             linetype="dashed") +
  guides(fill="none",col="none")+
  xlab("Standard Length (cm)")

```

```{r}
#| echo: false
kruskal.test(size ~ depth_layer, data = large_dataset)
pairwise.wilcox.test(large_dataset$size, large_dataset$depth_layer,
                     p.adjust.method = "BH")
```

## Density plot by depth layer - species level

```{r}
#| echo: false
#| fig-height: 15
#| fig-width: 15

large_dataset_significant <- subset(large_dataset, 
                                   species=="Lampanyctus crocodilus"|
                                   species=="Melanostigma atlanticum"|
                                   species=="Xenodermichthys copei" |
                                   species=="Myctophum punctatum")

large_dataset_significant$species <- factor(large_dataset_significant$species,
                                    levels = c("Lampanyctus crocodilus",
                                             "Melanostigma atlanticum",
                                             "Xenodermichthys copei",
                                             "Myctophum punctatum"))
    

density_plot <- ggplot(large_dataset_significant, aes(x=size)) +
  geom_density(alpha=0.3, linewidth=0.8, adjust= 2, fill= "darkblue", col="darkblue")+
  geom_histogram(aes(y=..density.., ), alpha=0.2, 
                 position="identity", binwidth = 1, col="darkblue", fill="darkblue")+
  facet_grid(depth_layer~species, scale="free")+
  theme_minimal()+
  theme(strip.text.x = element_text(size=18,face="italic"),
        strip.text.y = element_text(size=16),
        axis.title = element_text(size=16),
        axis.text =  element_text(size=13, color= "grey50"),
        panel.background=element_rect(color="white"),
        legend.title = element_text(size=14),
        legend.text = element_text(size=14))+
  guides(fill="none",col="none")+
  xlab("Standard Length (cm)")

lm_significant <- ggplot(large_dataset_significant, aes(x=trawling_depth, y=size))+
  geom_point (alpha=0.4, size=1.5, col= "darkblue") + 
  geom_smooth(method=lm, se=T, alpha=0.2, size= 1, col="darkgrey") +
  facet_wrap(~species, scale = "free", ncol=5)+ 
  ggpmisc::stat_poly_eq(formula = y ~ x, 
                        aes(label = paste(..eq.label.., ..rr.label.., ..p.value.label.. 
                                          , ..n.label..,sep = "*`,`~")),
                        parse = TRUE,
                        size= 3.4,
                        label.x.npc = "right",
                        label.y.npc = "bottom",
                        vstep = -0.0005)+
  scale_y_continuous(trans = 'log2') +
  ylab(bquote(log[2]~"standard length (cm)"))+
  xlab("")+
  guides(color="none", fill="none")+
  theme_minimal()+
  theme(strip.text.x = element_blank(),
        axis.title = element_text(size=14),
        axis.text =  element_text(size=12, color= "grey50"))

size_depth_sp <- ggpubr::ggarrange(density_plot,lm_significant, labels = c("A","B"),
                  nrow = 2, heights =  c(2, 1)) 

ggpubr::annotate_figure(size_depth_sp, bottom = ggpubr::text_grob("Depth (m)", size = 15))
```

### Wilcoxon test at species level:

***Lampanyctus crocodilus*** :

```{r}
#| echo: false 
Lamp_cro <- subset(size_distribution_complete, species == "Lampanyctus crocodilus")

kruskal.test(size ~ depth_layer, data = Lamp_cro)
pairwise.wilcox.test(Lamp_cro$size, Lamp_cro$depth_layer,
                     p.adjust.method = "BH")
```

***Melanostigma atlanticum***:

```{r}
#| echo: false
mela_atl <- subset(size_distribution_complete, species == "Melanostigma atlanticum")

kruskal.test(size ~ depth_layer, data = mela_atl)
pairwise.wilcox.test(mela_atl$size, mela_atl$depth_layer,
                     p.adjust.method = "BH")
```

***Xenodermichthys copei***:

```{r}
#| echo: false
xeno_cop <- subset(size_distribution_complete, species == "Xenodermichthys copei")

kruskal.test(size ~ depth_layer, data = xeno_cop)
pairwise.wilcox.test(xeno_cop$size, xeno_cop$depth_layer,
                     p.adjust.method = "BH")
```

***Myctophum punctatum***:

```{r}
#| echo: false
mycto_punc <- subset(size_distribution_complete, species == "Myctophum punctatum")

kruskal.test(size ~ depth_layer, data = mycto_punc)
pairwise.wilcox.test(mycto_punc$size, mycto_punc$depth_layer,
                     p.adjust.method = "BH")
```

# 2. $\delta$<sup>15</sup>N-size relationships

-   Sampling of some individuals to obtain $\delta$<sup>15</sup>N values

## At community level

-   Can we observe an increase in $\delta$<sup>15</sup>N values (proxy of trophic level) with increasing size of individuals in the deep pelagic fish community of the Bay of Biscay?

-   X axis (size) in log<sub>2</sub>

-   Significant increase but very small slope

```{r}
#| echo: false

ontogeny_data <- utils::read.csv(here::here("data", "ontogeny.csv"), sep = ";", header = T,dec = ",")

ontogeny_data$species <- factor(ontogeny_data$species,
                               levels = c("Stomias_boa",
                                          "Lampanyctus_crocodilus",
                                          "Myctophum_punctatum",
                                          "Aphanopus_carbo",
                                          "Melanostigma_atlanticum",
                                          "Serrivomer_beanii",
                                          "Argyropelecus_olfersii",
                                          "Lampanyctus_macdonaldi",
                                          "Searsia_koefoedi",
                                          "Notoscopelus_kroyeri",
                                          "Xenodermichthys_copei",
                                          "Arctozenus_risso"),
                               labels = c("Stomias boa",
                                          "Lampanyctus crocodilus",
                                          "Myctophum punctatum",
                                          "Aphanopus carbo",
                                          "Melanostigma atlanticum",
                                          "Serrivomer beanii",
                                          "Argyropelecus olfersii",
                                          "Lampanyctus macdonaldi",
                                          "Searsia koefoedi",
                                          "Notoscopelus kroyeri",
                                          "Xenodermichthys copei",
                                          "Arctozenus risso"))

ggplot(ontogeny_data , aes(x=size, y=d15N_muscle_untreated))+
  geom_point (alpha=0.4) + 
  geom_smooth(method=lm, se=T, alpha=0.2, col= alpha("darkblue",0.7)) + 
  ggpmisc::stat_poly_eq(formula = y ~ x, 
                        aes(label = paste(..eq.label.., ..rr.label.., ..p.value.label.. 
                                          , ..n.label..,sep = "*`,`~")),
                        parse = TRUE,
                        size=3,
                        label.x.npc = "right",
                        label.y.npc = "bottom",
                        vstep = -0.0005)+ 
  scale_x_continuous(trans = 'log2') +
  xlab(bquote(log[2]~"standard length (cm)"))+
  ylab(expression({delta}^15*N~'\u2030'))+
  ylim(c(7, 14))+
  guides(fill="none")+
  theme_minimal()+
  theme(strip.text.x = element_text(size=10,face="italic"),
        axis.title = element_text(size=10),
        axis.text =  element_text(size=10))
```

## At species level

-   $\delta$<sup>15</sup>N axis standardized

```{r}
#| echo: false
#| warning: false
#| fig-height: 15
#| fig-width: 10

library(ggplot2)

ontogeny_significant <- subset(ontogeny_data, species=="Lampanyctus crocodilus"|
                                         species=="Aphanopus carbo"|
                                         species=="Melanostigma atlanticum" |
                                         species=="Serrivomer beanii"|
                                         species=="Stomias boa"|
                                         species=="Myctophum punctatum"|
                                         species=="Arctozenus risso")

ontogeny_significant$species <- factor(ontogeny_significant$species,
                               levels = c("Myctophum punctatum",
                                          "Melanostigma atlanticum",
                                          "Lampanyctus crocodilus",
                                          "Stomias boa",
                                          "Serrivomer beanii",
                                          "Aphanopus carbo",
                                          "Arctozenus risso"))

ontogeny_non_significant <- subset(ontogeny_data, species=="Argyropelecus olfersii"|
                                 species=="Lampanyctus macdonaldi"|
                                 species=="Searsia koefoedi" |
                                 species=="Notoscopelus kroyeri"|
                                 species=="Xenodermichthys copei")

ontogeny_non_significant$species <- factor(ontogeny_non_significant$species,
                                       levels = c("Xenodermichthys copei",
                                                  "Searsia koefoedi",
                                                  "Argyropelecus olfersii",
                                                  "Lampanyctus macdonaldi",
                                                  "Notoscopelus kroyeri"))

plot_significant  <- ggplot(ontogeny_significant , aes(x=size, y=d15N_muscle_untreated))+
  geom_point (alpha=0.4, col="black") + 
  geom_smooth(method=lm, se=T, alpha=0.2, col= alpha("darkblue",0.7)) +
  facet_wrap(~species, scale="free_x", ncol=3)+ 
  ggpmisc::stat_poly_eq(formula = y ~ x, 
                        aes(label = paste(..eq.label.., ..rr.label.., ..p.value.label.. 
                                          , ..n.label..,sep = "*`,`~")),
                        parse = TRUE,
                        size=3.3,
                        label.x.npc = "right",
                        label.y.npc = "bottom",
                        vstep = -0.0005)+ 
  xlab("")+
  ylab(expression({delta}^15*N~'\u2030'))+
  ylim(c(7,13))+
  guides(color="none", fill="none")+
  theme_minimal()+
  theme(strip.text.x = element_text(size=13,face="italic"),
        axis.title = element_text(size=13),
        axis.text =  element_text(size=13))

plot_non_significant <- ggplot(ontogeny_non_significant, aes(x=size, y=d15N_muscle_untreated))+
  geom_point (alpha=0.4, col="black") + 
  facet_wrap(~species, scale="free_x", ncol=3, nrow = 3)+ 
  ggpmisc::stat_poly_eq(formula = y ~ x, 
                        aes(label = paste( ..n.label..,sep = "*`,`~")),
                        parse = TRUE,
                        size=3.3,
                        label.x.npc = "right",
                        label.y.npc = "bottom",
                        vstep = -0.0005)+ 
  xlab("Standard Length (cm)")+
  ylab(expression({delta}^15*N~'\u2030'))+
  ylim(c(7, 13))+
  guides(color="none", fill="none")+
  theme_minimal()+
  theme(strip.text.x = element_text(size=13,face="italic"),
        axis.title = element_text(size=13),
        axis.text =  element_text(size=13))

ggpubr::ggarrange(plot_significant, plot_non_significant, ncol=1, labels = c("A", "B"),
                  heights = c(2,1.2))

```

## Variation coefficients

-   The dispersion of the $\delta$<sup>15</sup>N values is not the same between the species having shown non-significant $\delta$<sup>15</sup>N-size relationships: *X. copei* presents a strong dispersion of its values (CV = 6.57) contrary to the values of *N. kroyeri* which remain relatively stable with the size of its individuals (CV = 2.15)

-   Do these differences translate into differences in their feeding strategies?

```{r}

cv <- function(x){
  (sd(x)/mean(x))*100
}

coeff_var <- aggregate(d15N_muscle_untreated ~ species, 
                       data = ontogeny_non_significant,
                       FUN = cv)
DT::datatable(coeff_var)
```

# 4. Variation partitionning

-   At the species level, is it the sampling depth or the size of the individuals that most influences the values in $\delta$<sup>15</sup>N?

## At community level

```{r}
#| echo: false
#| warning: false 
#| fig-height: 6
#| fig-width: 6

#Varpart
ontogeny_part <- vegan::varpart(ontogeny_data$d15N_muscle_untreated,
                            ~trawling_depth, ~size, data=ontogeny_data)
ontogeny_part$part

plot(ontogeny_part,
     Xnames = c("Depth", "size"), # name the partitions
     bg = c("#072AC8", "#0B5345"), alpha = 100, # colour the circles
     digits = 2, # only show 2 digits
     cex = 1.4)

vegan::anova.cca(vegan::rda(ontogeny_data$d15N_muscle_untreated, ontogeny_data$trawling_depth, ontogeny_data$size))
```

### Significance testing

#### \[a\] Depth alone

```{r}
#| echo: false
#| output: false
vegan::anova.cca(vegan::rda(ontogeny_data$d15N_muscle_untreated, ontogeny_data$trawling_depth, ontogeny_data$size))
```

#### \[a\] size alone

```{r}
#| echo: false
#| output: false
vegan::anova.cca(vegan::rda(ontogeny_data$d15N_muscle_untreated, ontogeny_data$size, ontogeny_data$trawling_depth))
```

## *Lampanyctus crocodilus*

```{r}
#| echo: false
#| warning: false 
#| fig-height: 6
#| fig-width: 6

#Varpart
lamp_cro <- subset (ontogeny_data, ontogeny_data$species == "Lampanyctus crocodilus")
lamp_cro_part <- vegan::varpart(lamp_cro$d15N_muscle_untreated,
                            ~trawling_depth, ~size, data =lamp_cro)
lamp_cro_part$part

plot(lamp_cro_part,
     Xnames = c("Depth", "size"), # name the partitions
     bg = c("#072AC8", "#0B5345"), alpha = 100, # colour the circles
     digits = 2, # only show 2 digits
     cex = 1.4)
```

### Significance testing

#### \[a\] Depth alone

```{r}
#| echo: false
#| output: false
vegan::anova.cca(vegan::rda(lamp_cro$d15N_muscle_untreated, lamp_cro$trawling_depth, lamp_cro$size))
```

#### \[c\] Size alone

```{r}
#| echo: false
#| output: false
vegan::anova.cca(vegan::rda(lamp_cro$d15N_muscle_untreated, lamp_cro$size, lamp_cro$trawling_depth))
```

## *Myctophum punctatum*

```{r}
#| echo: false
#| warning: false
#| fig-height: 6
#| fig-width: 6

#Varpart
myct_pun <- subset(ontogeny_data, ontogeny_data$species == "Myctophum punctatum")
myct_pun_part <- vegan::varpart(myct_pun$d15N_muscle_untreated,
                                ~trawling_depth, ~size, data =myct_pun)
plot(myct_pun_part,
     Xnames = c("Depth", "size"), # name the partitions
     bg = c("#072AC8", "#0B5345"), alpha = 100, # color the circles
     digits = 2, # only show 2 digits
     cex = 1.4)
```

```{r}
#| echo: false
#| output: false
vegan::anova.cca(vegan::rda(myct_pun$d15N_muscle_untreated, myct_pun$trawling_depth, myct_pun$size))
```

```{r}
#| echo: false
#| output: false
vegan::anova.cca(vegan::rda(myct_pun$d15N_muscle_untreated, myct_pun$size, myct_pun$trawling_depth))
```

## *Melanostigma atlanticum*

```{r}
#| echo: false
#| warning: false
#| fig-height: 6
#| fig-width: 6

#Varpart
mela_atl <- subset(ontogeny_data, ontogeny_data$species == "Melanostigma atlanticum")
mela_atl_part <- vegan::varpart(mela_atl$d15N_muscle_untreated,
                                ~trawling_depth, ~size, data = mela_atl)
plot(mela_atl_part,
     Xnames = c("Depth", "size"), # name the partitions
     bg = c("#072AC8", "#0B5345"), alpha = 100, # colour the circles
     digits = 2, # only show 2 digits
     cex = 1.4)

```

```{r}
#| echo: false
#| output: false
vegan::anova.cca(vegan::rda(mela_atl$d15N_muscle_untreated, mela_atl$trawling_depth,
                            mela_atl$size))
```

```{r}
#| echo: false
#| output: false
vegan::anova.cca(vegan::rda(mela_atl$d15N_muscle_untreated, mela_atl$size,
                            mela_atl$trawling_depth))
```

## *Serrivomer beanii*

```{r}
#| echo: false
#| warning: false
#| fig-height: 6
#| fig-width: 6

#Varpart
serr_bea <- subset(ontogeny_data, ontogeny_data$species == "Serrivomer beanii")
serr_bea_part <- vegan::varpart(serr_bea$d15N_muscle_untreated,
                                ~trawling_depth, ~size, data = serr_bea)
plot(serr_bea_part,
     Xnames = c("Depth", "size"), # name the partitions
     bg = c("#072AC8", "#0B5345"), alpha = 100, # colour the circles
     digits = 2, # only show 2 digits
     cex = 1.4)

```

```{r}
#| echo: false
#| output: false
vegan::anova.cca(vegan::rda(serr_bea$d15N_muscle_untreated, serr_bea$trawling_depth,
                            serr_bea$size))
```

```{r}
#| echo: false
#| output: false
vegan::anova.cca(vegan::rda(serr_bea$d15N_muscle_untreated, serr_bea$size,
                            serr_bea$trawling_depth))
```

## *Argyropelecus olfersii*

```{r}
#| echo: false
#| warning: false
#| #| fig-height: 6
#| fig-width: 6

#Varpart
argy_olf <- subset(ontogeny_data, ontogeny_data$species == "Argyropelecus olfersii")
argy_olf_part <- vegan::varpart(argy_olf$d15N_muscle_untreated,
                                ~trawling_depth, ~size, data = argy_olf)
plot(argy_olf_part,
     Xnames = c("Depth", "size"), # name the partitions
     bg = c("#072AC8", "#0B5345"), alpha = 100, # colour the circles
     digits = 2, # only show 2 digits
     cex = 1.4)
```

```{r}
#| echo: false
#| output: false
vegan::anova.cca(vegan::rda(argy_olf$d15N_muscle_untreated, argy_olf$trawling_depth,
                            argy_olf$size))
```

```{r}
#| echo: false
#| output: false
vegan::anova.cca(vegan::rda(argy_olf$d15N_muscle_untreated, argy_olf$size,
                            argy_olf$trawling_depth))
```

## *Lampanyctus macdonaldi*

```{r}
#| echo: false
#| warning: false
#| fig-height: 6
#| fig-width: 6

#Varpart
lamp_mac <- subset(ontogeny_data, ontogeny_data$species == "Lampanyctus macdonaldi")
lamp_mac_part <- vegan::varpart(lamp_mac$d15N_muscle_untreated,
                                ~trawling_depth, ~size, data = lamp_mac)
plot(lamp_mac_part,
     Xnames = c("Depth", "size"), # name the partitions
     bg = c("#072AC8", "#0B5345"), alpha = 100, # colour the circles
     digits = 2, # only show 2 digits
     cex = 1.4)

```

```{r}
#| echo: false
#| output: false
vegan::anova.cca(vegan::rda(lamp_mac$d15N_muscle_untreated, lamp_mac$trawling_depth,
                            lamp_mac$size))
```

```{r}
#| echo: false
#| output: false
vegan::anova.cca(vegan::rda(lamp_mac$d15N_muscle_untreated, lamp_mac$size,
                            lamp_mac$trawling_depth))
```

## *Searsia koefoedi*

```{r}
#| echo: false
#| warning: false
#| fig-height: 6
#| fig-width: 6

#Varpart
sear_koe <- subset(ontogeny_data, ontogeny_data$species == "Searsia koefoedi")
sear_koe_part <- vegan::varpart(sear_koe$d15N_muscle_untreated,
                                ~trawling_depth, ~size, data = sear_koe)
plot(sear_koe_part,
     Xnames = c("Depth", "size"), # name the partitions
     bg = c("#072AC8", "#0B5345"), alpha = 100, # colour the circles
     digits = 2, # only show 2 digits
     cex = 1.4)
```

```{r}
#| echo: false
#| output: false
vegan::anova.cca(vegan::rda(sear_koe$d15N_muscle_untreated, sear_koe$trawling_depth,
                            sear_koe$size))
```

```{r}
#| echo: false
#| output: false
vegan::anova.cca(vegan::rda(sear_koe$d15N_muscle_untreated, sear_koe$size,
                            sear_koe$trawling_depth))
```

## *Notoscopelus kroyeri*

```{r}
#| echo: false
#| warning: false
#| fig-height: 6
#| fig-width: 6

#Varpart
noto_kro <- subset(ontogeny_data, ontogeny_data$species == "Notoscopelus kroyeri")
noto_kro_part <- vegan::varpart(noto_kro$d15N_muscle_untreated,
                                ~trawling_depth, ~size, data = noto_kro)
plot(noto_kro_part,
     Xnames = c("Depth", "size"), # name the partitions
     bg = c("#072AC8", "#0B5345"), alpha = 100, # colour the circles
     digits = 2, # only show 2 digits
     cex = 1.4)
```

```{r}
#| echo: false
#| output: false
vegan::anova.cca(vegan::rda(noto_kro$d15N_muscle_untreated, noto_kro$trawling_depth,
                            noto_kro$size))
```

```{r}
#| echo: false
#| output: false
vegan::anova.cca(vegan::rda(noto_kro$d15N_muscle_untreated, noto_kro$size,
                            noto_kro$trawling_depth))
```

## *Xenodermichthys copei*

```{r}
#| echo: false
#| warning: false
#| fig-height: 6
#| fig-width: 6

#Varpart
xeno_cop <- subset(ontogeny_data, ontogeny_data$species == "Xenodermichthys copei")
xeno_cop_part <- vegan::varpart(xeno_cop$d15N_muscle_untreated,
                                ~trawling_depth, ~size, data = xeno_cop)
plot(xeno_cop_part,
     Xnames = c("Depth", "size"), # name the partitions
     bg = c("#072AC8", "#0B5345"), alpha = 100, # colour the circles
     digits = 2, # only show 2 digits
     cex = 1.4)
```

```{r}
#| echo: false
#| output: false
vegan::anova.cca(vegan::rda(xeno_cop$d15N_muscle_untreated, xeno_cop$trawling_depth,
                            xeno_cop$size))
```

```{r}
#| echo: false
#| output: false
vegan::anova.cca(vegan::rda(xeno_cop$d15N_muscle_untreated, xeno_cop$size,
                            xeno_cop$trawling_depth))
```

## *Arctozenus risso*

```{r}
#| echo: false
#| warning: false
#| fig-height: 6
#| fig-width: 6

#Varpart
arct_ris <- subset(ontogeny_data, ontogeny_data$species == "Arctozenus risso")
arct_ris_part <- vegan::varpart(arct_ris$d15N_muscle_untreated,
                                ~trawling_depth, ~size, data = arct_ris)
plot(arct_ris_part,
     Xnames = c("Depth", "size"), # name the partitions
     bg = c("#072AC8", "#0B5345"), alpha = 100, # colour the circles
     digits = 2, # only show 2 digits
     cex = 1.4)
```

```{r}
#| echo: false
#| output: false
vegan::anova.cca(vegan::rda(arct_ris$d15N_muscle_untreated, arct_ris$trawling_depth,
                            arct_ris$size))
```

```{r}
#| echo: false
#| output: false
vegan::anova.cca(vegan::rda(arct_ris$d15N_muscle_untreated, arct_ris$size,
                            arct_ris$trawling_depth))
```

## Variance partitionning summary

```{r}
#| echo: false
#| fig-height: 7
#| fig-width: 13

library(dplyr)
variation_coeffcients <- utils::read.csv(here::here("data", "variation_coeffcients.csv"), sep = ";", header = T, dec = ",")

var_coeff_resi <- variation_coeffcients%>%
  filter(variation_coeffcients$relation != "residuals")

var_coeff_resi$species <- factor(var_coeff_resi$species,
                                         levels = c("Community",
                                                    "Notoscopelus kroyeri",
                                                    "Searsia koefoedi",
                                                    "Lampanyctus macdonaldi",
                                                    "Melanostigma atlanticum",
                                                    "Xenodermichthys copei",
                                                    "Argyropelecus olfersii",
                                                    "Arctozenus risso",
                                                    "Serrivomer beanii",
                                                    "Myctophum punctatum",
                                                    "Lampanyctus crocodilus"))


# Stacked + percent
ggplot(var_coeff_resi, aes(fill=relation, y=value, x=species)) + 
  geom_bar(position="stack", stat="identity", alpha=0.4, size=0.6, aes(col=relation))+
  paletteer::scale_fill_paletteer_d("ggthemes::excel_Aspect", labels=c("Depth","Depth and size", "Size"))+
  paletteer::scale_color_paletteer_d("ggthemes::excel_Aspect")+
  theme_minimal()+
  coord_flip()+
  theme(axis.text.y = element_text(face ="italic", size=15),
        axis.title = element_text(size=15),
        legend.text = element_text(size=15),
        legend.title = element_text(size=15),
        axis.text.x = element_text(size=15))+
  guides(fill=guide_legend(title="Explanatory variables"),
         color="none")

        
```

# 5. Summary table

**Testing significance:**

-   $\delta$<sup>15</sup>N - Size & $\delta$<sup>15</sup>N - depth : use of the anova.cca() function to test the significance of each part separately (depth & size) on the variability of $\delta$<sup>15</sup>N values
-   Depth - size : test with linear model lm (size\~depth)
-   *Stomias boa* & *Aphanopus carbo* \* depth range too small (\< 100m) so no use of variance partition models on these species, but linear models $\delta$<sup>15</sup>N - size significant

![Summary table](summary_table.jpg){width="70%"}

# 6. Limits

## Test of temporal variability on $\delta$<sup>15</sup>N values

-   Difficult to test because it is necessary to eliminate the biases due to size and depth.

-   However, over 90% of the sampling has been completed between 2019 and 2021 (and almost 3/4 in 2021)

-   If major environmental changes had occurred that significantly altered the baseline over time, this would have been observed in all species in the same way, which does not appear to be the case here

-   Test with *Lampnyctus crocodilus*: In the bathypelagic layer and individuals between 10 and 12cm : non signifiant differences

-   we can see that the data from the different years merge, there does not seem to be a strong effect of the year of sampling on the $\delta$<sup>15</sup>N values

-   In supplementary material ?

-   

    -   only night sampling

```{r}
#| echo: false
#| warning: false 
#| fig-height: 18
#| fig-width: 25

ontogeny_data$years <- as.character(ontogeny_data$years)

ggplot(ontogeny_data , aes(x=size, y=d15N_muscle_untreated))+
  geom_point (alpha=0.7, aes(col=years), size=4) + 
  paletteer::scale_color_paletteer_d("ggsci::default_ucscgb")+
  facet_wrap(~species, scale="free_x")+ 
  xlab("Standard Length (cm)")+
  ylab(expression({delta}^15*N~'\u2030'))+
  theme_minimal()+
  theme(strip.text.x = element_text(size=22,face="italic"),
        axis.title = element_text(size=22),
        axis.text =  element_text(size=22),
        legend.title = element_text(size=22),
        legend.text = element_text(size=22))

```

## Representativeness of the sampling of individuals for $\delta$<sup>15</sup>N values

-   In supplementary material ?
-   no sampling of small *M. atlanticum* and big *L. macdonaldi*
-   but overall good sampling coverage over the size ranges of the species

```{r}
#| echo: false
#| warning: false 
#| fig-height: 10
#| fig-width: 20

ggplot(size_distribution_complete, aes(x=size)) +
  geom_density(alpha=0.3, linewidth=0.7, aes(col=dataset, fill= dataset))+
  scale_color_manual(values = c("#6FB668", "#A070FF"), labels = c("Sub-sampled data set (individuals sampled isotopy)", "Initial data set"))+
  scale_fill_manual(values = c("#6FB668", "#A070FF"), labels = c("Sub-sampled data set (individuals sampled isotopy)", "Initial data set"))+
  facet_wrap(~species, scale="free")+
  theme_minimal()+
  theme(strip.text.x = element_text(size=16,face="italic"),
        strip.text.y = element_text(size=17),
        axis.title = element_text(size=19),
        axis.text =  element_text(size=14, color= "grey50"),
        panel.background=element_rect(color="white"),
        legend.title = element_text(size=19),
        legend.text = element_text(size=19))+
  xlab("Standard length (cm)")+
  guides(fill=guide_legend(title="Dataset"), col=guide_legend(title="Dataset"))
```
