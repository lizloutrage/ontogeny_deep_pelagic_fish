---
title: "Ontogeny of deep pelagic fish"
format: 
  html:
    self-contained: false
    code-fold: true
editor: source
theme: minty
keep-md: true
execute:
  warning: false
  message : false
toc: true
toc-title: Sections
toc-location: left
page-layout: full
---

# 1. Size distribution as a function of depth

## Density plot by depth layer - community level

-   Bigger fish at depth ?

```{r}
#| echo: false
#| fig-height: 8
#| fig-width: 7
#| label: size_depth_community

#Library
library(tidyr)
library(dplyr)
library(ggplot2)

size_distribution_complete <- utils::read.csv(here::here("data", "size_distribution_complete.csv"), sep = ";", header = T,dec = ".")

# Complete size data set (2002-2021)
large_dataset <- filter(size_distribution_complete, dataset == "Total")

large_dataset$depth_layer <- factor(large_dataset$depth_layer, 
                                  levels = c("epipelagic","upper_mesopelagic",
                                         "lower_mesopelagic","bathypelagic"),
                                  labels = c("Epipelagic","Upper mesopelagic",
                                          "Lower mesopelagic","Bathypelagic"))

ggplot(large_dataset, aes(x=size)) +
  geom_density(alpha=0.3, linewidth=1, bw=0.2, aes(col=depth_layer, fill= depth_layer))+
  paletteer::scale_color_paletteer_d("jcolors::pal10")+
  paletteer::scale_fill_paletteer_d("jcolors::pal10")+
  facet_wrap(~depth_layer, ncol=1, scales = "free_y") +
  theme_minimal()+
  scale_x_continuous(trans = 'log2') +
  theme(strip.text.x = element_text(size=12,face="bold"),
        strip.text.y = element_text(size=12),
        axis.title = element_text(size=12),
        axis.text =  element_text(size=12, color= "grey50"),
        panel.background=element_rect(color="white"),
        legend.title = element_text(size=12),
        legend.text = element_text(size=12))+
  guides(fill="none",col="none")+
  xlab("log2 standard Length (cm)")

```
### Test of the significance of the size-depth relationship - community level
```{r}
#| echo: false
#| fig-height: 5
#| fig-width: 7
#| label: size_depth_community_lm

ggplot(large_dataset, aes(x=trawling_depth, y=size))+
  geom_point (alpha=0.4) + 
  geom_smooth(method=lm, se=T, alpha=0.2, col= alpha("darkblue",0.7)) +
  ggpmisc::stat_poly_eq(formula = y ~ x, 
                        aes(label = paste(..eq.label.., ..rr.label.., ..p.value.label.. 
                                          , ..n.label..,sep = "*`,`~")),
                        parse = TRUE,
                        size= 3.4,
                        label.x.npc = "right",
                        label.y.npc = "bottom",
                        vstep = -0.0005)+
  scale_y_continuous(trans = 'log2') +
  ylab(bquote(log[2]~"standard length (cm)"))+
  xlab("Depth (m)")+
  guides(color="none", fill="none")+
  theme_minimal()+
  theme(axis.title = element_text(size=14),
        axis.text =  element_text(size=12, color= "grey50"))
```


## Density plot by depth layer - species level

-  Only significant relationships (non-significant relationships in supplementary materials)
```{r}
#| echo: false
#| fig-height: 10
#| fig-width: 13
#| label: size_depth_species

# selection of species with a significant size-depth relationship 
large_dataset_significant <- filter(large_dataset, 
                                    species %in% c("Lampanyctus crocodilus","Melanostigma atlanticum",
                                                   "Xenodermichthys copei","Myctophum punctatum"))

large_dataset_significant$species <- factor(large_dataset_significant$species,
                                    levels = c("Lampanyctus crocodilus",
                                             "Melanostigma atlanticum",
                                             "Xenodermichthys copei",
                                             "Myctophum punctatum"))
    

ggplot(large_dataset_significant, aes(x=size)) +
  geom_density(alpha=0.3, linewidth=0.8, adjust= 2, aes(fill= depth_layer, col= depth_layer))+
  geom_histogram(aes(y=..density.., fill= depth_layer, col= depth_layer), alpha=0.2, 
                 position="identity", binwidth = 1)+
  paletteer::scale_color_paletteer_d("jcolors::pal10")+
  paletteer::scale_fill_paletteer_d("jcolors::pal10")+
  facet_grid(depth_layer~species, scale="free")+
  theme_minimal()+
  theme(strip.text.x = element_text(size=16,face="italic"),
        strip.text.y = element_text(size=15),
        axis.title = element_text(size=15),
        axis.text =  element_text(size=15, color= "grey50"),
        panel.background=element_rect(color="white"),
        legend.title = element_text(size=17),
        legend.text = element_text(size=17))+
  guides(fill="none",col="none")+
  xlab("Standard Length (cm)")
```
# Linear relationships
```{r}
#| echo: false
#| fig-height: 7
#| fig-width: 10
#| label: size_depth_species_lm

ggplot(large_dataset_significant, aes(x=trawling_depth, y=size))+
  geom_point (alpha=0.4) + 
  facet_wrap(~species, scales = "free")+
  geom_smooth(method=lm, se=T, alpha=0.2, col= alpha("darkblue",0.7)) + 
  ggpmisc::stat_poly_eq(formula = y ~ x, 
                        aes(label = paste(..eq.label.., ..rr.label.., ..p.value.label.. 
                                          , ..n.label..,sep = "*`,`~")),
                        parse = TRUE,
                        size=3,
                        label.x.npc = "right",
                        label.y.npc = "bottom",
                        vstep = -0.0005)+ 
  xlab(bquote(log[2]~"standard length (cm)"))+
  ylab("Depth (m)")+
  guides(fill="none")+
  theme_minimal()+
  theme(strip.text.x = element_text(size=10,face="italic"),
        axis.title = element_text(size=10),
        axis.text =  element_text(size=10))
```


# 2. $\delta$<sup>15</sup>N-size relationships

-   Sampling of some individuals to obtain $\delta$<sup>15</sup>N values

## At community level

-   Can we observe an increase in $\delta$<sup>15</sup>N values (proxy of trophic level) with increasing size of individuals in the deep pelagic fish community of the Bay of Biscay?

-   X axis (size) in log<sub>2</sub>

-   Significant increase but very small slope

```{r}
#| echo: false
#| label: d15n_size_community

ontogeny_data <- utils::read.csv(here::here("data", "ontogeny.csv"), sep = ";", header = T,dec = ",")

ontogeny_data$species <- factor(ontogeny_data$species,
                               levels = c("Stomias_boa",
                                          "Lampanyctus_crocodilus",
                                          "Myctophum_punctatum",
                                          "Aphanopus_carbo",
                                          "Melanostigma_atlanticum",
                                          "Serrivomer_beanii",
                                          "Argyropelecus_olfersii",
                                          "Lampanyctus_macdonaldi",
                                          "Searsia_koefoedi",
                                          "Notoscopelus_kroyeri",
                                          "Xenodermichthys_copei",
                                          "Arctozenus_risso"),
                               labels = c("Stomias boa",
                                          "Lampanyctus crocodilus",
                                          "Myctophum punctatum",
                                          "Aphanopus carbo",
                                          "Melanostigma atlanticum",
                                          "Serrivomer beanii",
                                          "Argyropelecus olfersii",
                                          "Lampanyctus macdonaldi",
                                          "Searsia koefoedi",
                                          "Notoscopelus kroyeri",
                                          "Xenodermichthys copei",
                                          "Arctozenus risso"))

ggplot(ontogeny_data , aes(x=size, y=d15N_muscle_untreated))+
  geom_point (alpha=0.4) + 
  geom_smooth(method=lm, se=T, alpha=0.2, col= alpha("darkblue",0.7)) + 
  ggpmisc::stat_poly_eq(formula = y ~ x, 
                        aes(label = paste(..eq.label.., ..rr.label.., ..p.value.label.. 
                                          , ..n.label..,sep = "*`,`~")),
                        parse = TRUE,
                        size=4,
                        label.x.npc = "right",
                        label.y.npc = "bottom",
                        vstep = -0.0005)+ 
  scale_x_continuous(trans = 'log2') +
  xlab(bquote(log[2]~"standard length (cm)"))+
  ylab(expression({delta}^15*N~'\u2030'))+
  ylim(c(7, 14))+
  guides(fill="none")+
  theme_minimal()+
  theme(strip.text.x = element_text(size=12,face="italic"),
        axis.title = element_text(size=12),
        axis.text =  element_text(size=12))
```

## At species level

-   $\delta$<sup>15</sup>N axis standardized
-  __A__: significant relationships 
-  __B__: non-significant relationships 
-  __Coefficient of variation__: The dispersion of the $\delta$<sup>15</sup>N values is not the same between the species having shown non-significant $\delta$<sup>15</sup>N-size relationships: *X. copei* presents a strong dispersion of its values (CV = 6.57) contrary to the values of *N. kroyeri* which remain relatively stable with the size of its individuals (CV = 2.15)
-   Do these differences translate into differences in their feeding strategies?

```{r}
#| echo: false
#| warning: false
#| fig-height: 15
#| fig-width: 10
#| label: d15_size_species

# Selection of species presenting significant d15N-size relationship
ontogeny_significant <- filter(ontogeny_data,
                               species %in% c("Lampanyctus crocodilus", "Aphanopus carbo",
                                              "Melanostigma atlanticum", "Serrivomer beanii",
                                              "Stomias boa", "Myctophum punctatum","Arctozenus risso"))
  
ontogeny_significant$species <- factor(ontogeny_significant$species,
                               levels = c("Myctophum punctatum",
                                          "Melanostigma atlanticum",
                                          "Lampanyctus crocodilus",
                                          "Stomias boa",
                                          "Serrivomer beanii",
                                          "Aphanopus carbo",
                                          "Arctozenus risso"))


plot_significant <- ggplot(ontogeny_significant, aes(x=size, y=d15N_muscle_untreated))+
  geom_point (alpha=0.4, col="black") + 
  geom_smooth(method=lm, se=T, alpha=0.2, col= alpha("darkblue",0.7)) +
  facet_wrap(~species, scale="free_x", ncol=3)+ 
  ggpmisc::stat_poly_eq(formula = y ~ x, 
                        aes(label = paste(..eq.label.., ..rr.label.., ..p.value.label.. 
                                          , ..n.label..,sep = "*`,`~")),
                        parse = TRUE,
                        size=3.38,
                        label.x.npc = "right",
                        label.y.npc = "bottom",
                        vstep = -0.0005)+ 
  xlab("")+
  ylab(expression({delta}^15*N~'\u2030'))+
  ylim(c(7,13))+
  guides(color="none", fill="none")+
  theme_minimal()+
  theme(strip.text.x = element_text(size=15,face="italic"),
        axis.title = element_text(size=15),
        axis.text =  element_text(size=15))


# Selection of species presenting non-significant d15N-size relationship
ontogeny_non_significant <- filter(ontogeny_data,
                                   species %in% c("Argyropelecus olfersii", "Lampanyctus macdonaldi",
                                                  "Searsia koefoedi", "Notoscopelus kroyeri",
                                                  "Xenodermichthys copei"))

ontogeny_non_significant$species <- factor(ontogeny_non_significant$species,
                                       levels = c("Xenodermichthys copei",
                                                  "Searsia koefoedi",
                                                  "Argyropelecus olfersii",
                                                  "Lampanyctus macdonaldi",
                                                  "Notoscopelus kroyeri"))

# function to calculate coefficient of variation 
cv <- function(x){
  (sd(x)/mean(x))*100
}
coeff_var <- aggregate(d15N_muscle_untreated ~ species, 
                       data = ontogeny_non_significant,
                       FUN = cv)
coeff_var$d15N_muscle_untreated <-round(coeff_var$d15N_muscle_untreated, digits = 2)


plot_non_significant <- ggplot(ontogeny_non_significant, aes(x=size, y=d15N_muscle_untreated))+
  geom_point (alpha=0.4, col="black") + 
  facet_wrap(~species, scale="free_x", ncol=3, nrow = 3)+ 
  ggpmisc::stat_poly_eq(formula = y ~ x, 
                        aes(label = paste( ..n.label..,sep = "*`,`~")),
                        parse = TRUE,
                        size=4,
                        label.x.npc = "right",
                        label.y.npc = "bottom",
                        vstep = -0.0005)+ 
  xlab("Standard Length (cm)")+
  ylab(expression({delta}^15*N~'\u2030'))+
  ylim(c(7, 14))+
  guides(color="none", fill="none")+
  theme_minimal()+
  theme(strip.text.x = element_text(size=15,face="italic"),
        axis.title = element_text(size=15),
        axis.text =  element_text(size=15))+
  geom_text(coeff_var, mapping = aes(x = -Inf, y = -Inf, label = paste("CV = ", d15N_muscle_untreated, sep = "")),
    hjust = -0.2, vjust   = -1.1, size = 4)

ggpubr::ggarrange(plot_significant, plot_non_significant, ncol=1, labels = c("A", "B"),
                  heights = c(2,1.2))

```

# 4. Variation partitionning

-   At the species level, is it the sampling depth or the size of the individuals that most influences the values in $\delta$<sup>15</sup>N?
-  To test the significance of the influence of each variable (depth and size) on \(\delta\)$^{15}$N values an ANOVA-type permutation test was performed for each model (anova.cca function)
-  Since the third fraction is not the result of an RDA, it cannot be tested for significance.

## At community level

```{r}
#| echo: false
#| warning: false 
#| fig-height: 6
#| fig-width: 6

ontogeny_part <- vegan::varpart(ontogeny_data$d15N_muscle_untreated,
                            ~trawling_depth, ~size, data=ontogeny_data)
plot(ontogeny_part,
     Xnames = c("Depth", "size"), # name the partitions
     bg = c("#072AC8", "#0B5345"), alpha = 100, # colour the circles
     digits = 2, # only show 2 digits
     cex = 1.4)
```

```{r}
#| echo: false
#| warning: false
#| output: false

# Significance testing - depth alone 
vegan::anova.cca(vegan::rda(ontogeny_data$d15N_muscle_untreated, ontogeny_data$trawling_depth, ontogeny_data$size))
```

```{r}
#| echo: false
#| output: false
#| warning: false 

# Significance testing - size alone 
vegan::anova.cca(vegan::rda(ontogeny_data$d15N_muscle_untreated, ontogeny_data$size, ontogeny_data$trawling_depth))
```

## *Lampanyctus crocodilus*

```{r}
#| echo: false
#| warning: false
#| fig-height: 6
#| fig-width: 6

lamp_cro <- filter(ontogeny_data, species=="Lampanyctus crocodilus")
lamp_cro_part <- vegan::varpart(lamp_cro$d15N_muscle_untreated,
                            ~trawling_depth, ~size, data =lamp_cro)
plot(lamp_cro_part,
     Xnames = c("Depth", "size"), # name the partitions
     bg = c("#072AC8", "#0B5345"), alpha = 100, # colour the circles
     digits = 2, # only show 2 digits
     cex = 1.4)
```


```{r}
#| echo: false
#| warning: false
#| output: false

vegan::anova.cca(vegan::rda(lamp_cro$d15N_muscle_untreated, lamp_cro$trawling_depth, lamp_cro$size))
```

```{r}
#| echo: false
#| warning: false
#| output: false
vegan::anova.cca(vegan::rda(lamp_cro$d15N_muscle_untreated, lamp_cro$size, lamp_cro$trawling_depth))
```

## *Myctophum punctatum*

```{r}
#| echo: false
#| warning: false
#| fig-height: 6
#| fig-width: 6

myct_pun <- filter(ontogeny_data, species == "Myctophum punctatum")
myct_pun_part <- vegan::varpart(myct_pun$d15N_muscle_untreated,
                                ~trawling_depth, ~size, data =myct_pun)
plot(myct_pun_part,
     Xnames = c("Depth", "size"), # name the partitions
     bg = c("#072AC8", "#0B5345"), alpha = 100, # color the circles
     digits = 2, # only show 2 digits
     cex = 1.4)
```

```{r}
#| echo: false
#| output: false
vegan::anova.cca(vegan::rda(myct_pun$d15N_muscle_untreated, myct_pun$trawling_depth, myct_pun$size))
```

```{r}
#| echo: false
#| output: false
vegan::anova.cca(vegan::rda(myct_pun$d15N_muscle_untreated, myct_pun$size, myct_pun$trawling_depth))
```

## *Melanostigma atlanticum*

```{r}
#| echo: false
#| warning: false
#| fig-height: 6
#| fig-width: 6

mela_atl <- filter(ontogeny_data, species == "Melanostigma atlanticum")
mela_atl_part <- vegan::varpart(mela_atl$d15N_muscle_untreated,
                                ~trawling_depth, ~size, data = mela_atl)
plot(mela_atl_part,
     Xnames = c("Depth", "size"), # name the partitions
     bg = c("#072AC8", "#0B5345"), alpha = 100, # colour the circles
     digits = 2, # only show 2 digits
     cex = 1.4)

```

```{r}
#| echo: false
#| output: false
vegan::anova.cca(vegan::rda(mela_atl$d15N_muscle_untreated, mela_atl$trawling_depth,
                            mela_atl$size))
```

```{r}
#| echo: false
#| output: false
vegan::anova.cca(vegan::rda(mela_atl$d15N_muscle_untreated, mela_atl$size,
                            mela_atl$trawling_depth))
```

## *Serrivomer beanii*

```{r}
#| echo: false
#| warning: false
#| fig-height: 6
#| fig-width: 6

serr_bea <- filter(ontogeny_data, species == "Serrivomer beanii")
serr_bea_part <- vegan::varpart(serr_bea$d15N_muscle_untreated,
                                ~trawling_depth, ~size, data = serr_bea)
plot(serr_bea_part,
     Xnames = c("Depth", "size"), # name the partitions
     bg = c("#072AC8", "#0B5345"), alpha = 100, # colour the circles
     digits = 2, # only show 2 digits
     cex = 1.4)

```

```{r}
#| echo: false
#| output: false
vegan::anova.cca(vegan::rda(serr_bea$d15N_muscle_untreated, serr_bea$trawling_depth,
                            serr_bea$size))
```

```{r}
#| echo: false
#| output: false
vegan::anova.cca(vegan::rda(serr_bea$d15N_muscle_untreated, serr_bea$size,
                            serr_bea$trawling_depth))
```

## *Argyropelecus olfersii*

```{r}
#| echo: false
#| warning: false
#| fig-height: 6
#| fig-width: 6

argy_olf <- filter(ontogeny_data, species == "Argyropelecus olfersii")
argy_olf_part <- vegan::varpart(argy_olf$d15N_muscle_untreated,
                                ~trawling_depth, ~size, data = argy_olf)
plot(argy_olf_part,
     Xnames = c("Depth", "size"), # name the partitions
     bg = c("#072AC8", "#0B5345"), alpha = 100, # colour the circles
     digits = 2, # only show 2 digits
     cex = 1.4)
```

```{r}
#| echo: false
#| output: false
vegan::anova.cca(vegan::rda(argy_olf$d15N_muscle_untreated, argy_olf$trawling_depth,
                            argy_olf$size))
```

```{r}
#| echo: false
#| output: false
vegan::anova.cca(vegan::rda(argy_olf$d15N_muscle_untreated, argy_olf$size,
                            argy_olf$trawling_depth))
```

## *Lampanyctus macdonaldi*

```{r}
#| echo: false
#| warning: false
#| fig-height: 6
#| fig-width: 6

lamp_mac <- filter(ontogeny_data, species == "Lampanyctus macdonaldi")
lamp_mac_part <- vegan::varpart(lamp_mac$d15N_muscle_untreated,
                                ~trawling_depth, ~size, data = lamp_mac)
plot(lamp_mac_part,
     Xnames = c("Depth", "size"), # name the partitions
     bg = c("#072AC8", "#0B5345"), alpha = 100, # colour the circles
     digits = 2, # only show 2 digits
     cex = 1.4)

```

```{r}
#| echo: false
#| output: false
vegan::anova.cca(vegan::rda(lamp_mac$d15N_muscle_untreated, lamp_mac$trawling_depth,
                            lamp_mac$size))
```

```{r}
#| echo: false
#| output: false
vegan::anova.cca(vegan::rda(lamp_mac$d15N_muscle_untreated, lamp_mac$size,
                            lamp_mac$trawling_depth))
```

## *Searsia koefoedi*

```{r}
#| echo: false
#| warning: false
#| fig-height: 6
#| fig-width: 6

sear_koe <- filter(ontogeny_data, species == "Searsia koefoedi")
sear_koe_part <- vegan::varpart(sear_koe$d15N_muscle_untreated,
                                ~trawling_depth, ~size, data = sear_koe)
plot(sear_koe_part,
     Xnames = c("Depth", "size"), # name the partitions
     bg = c("#072AC8", "#0B5345"), alpha = 100, # colour the circles
     digits = 2, # only show 2 digits
     cex = 1.4)
```

```{r}
#| echo: false
#| output: false
vegan::anova.cca(vegan::rda(sear_koe$d15N_muscle_untreated, sear_koe$trawling_depth,
                            sear_koe$size))
```

```{r}
#| echo: false
#| output: false
vegan::anova.cca(vegan::rda(sear_koe$d15N_muscle_untreated, sear_koe$size,
                            sear_koe$trawling_depth))
```

## *Notoscopelus kroyeri*

```{r}
#| echo: false
#| warning: false
#| fig-height: 6
#| fig-width: 6

#Varpart
noto_kro <- filter(ontogeny_data, species == "Notoscopelus kroyeri")
noto_kro_part <- vegan::varpart(noto_kro$d15N_muscle_untreated,
                                ~trawling_depth, ~size, data = noto_kro)
plot(noto_kro_part,
     Xnames = c("Depth", "size"), # name the partitions
     bg = c("#072AC8", "#0B5345"), alpha = 100, # colour the circles
     digits = 2, # only show 2 digits
     cex = 1.4)
```

```{r}
#| echo: false
#| output: false
vegan::anova.cca(vegan::rda(noto_kro$d15N_muscle_untreated, noto_kro$trawling_depth,
                            noto_kro$size))
```

```{r}
#| echo: false
#| output: false
vegan::anova.cca(vegan::rda(noto_kro$d15N_muscle_untreated, noto_kro$size,
                            noto_kro$trawling_depth))
```

## *Xenodermichthys copei*

```{r}
#| echo: false
#| warning: false
#| fig-height: 6
#| fig-width: 6

xeno_cop <- filter(ontogeny_data, species == "Xenodermichthys copei")
xeno_cop_part <- vegan::varpart(xeno_cop$d15N_muscle_untreated,
                                ~trawling_depth, ~size, data = xeno_cop)
plot(xeno_cop_part,
     Xnames = c("Depth", "size"), # name the partitions
     bg = c("#072AC8", "#0B5345"), alpha = 100, # colour the circles
     digits = 2, # only show 2 digits
     cex = 1.4)
```

```{r}
#| echo: false
#| output: false
vegan::anova.cca(vegan::rda(xeno_cop$d15N_muscle_untreated, xeno_cop$trawling_depth,
                            xeno_cop$size))
```

```{r}
#| echo: false
#| output: false
vegan::anova.cca(vegan::rda(xeno_cop$d15N_muscle_untreated, xeno_cop$size,
                            xeno_cop$trawling_depth))
```

## *Arctozenus risso*

```{r}
#| echo: false
#| warning: false
#| fig-height: 6
#| fig-width: 6

arct_ris <- filter(ontogeny_data, species == "Arctozenus risso")
arct_ris_part <- vegan::varpart(arct_ris$d15N_muscle_untreated,
                                ~trawling_depth, ~size, data = arct_ris)
plot(arct_ris_part,
     Xnames = c("Depth", "size"), # name the partitions
     bg = c("#072AC8", "#0B5345"), alpha = 100, # colour the circles
     digits = 2, # only show 2 digits
     cex = 1.4)
```

```{r}
#| echo: false
#| output: false
vegan::anova.cca(vegan::rda(arct_ris$d15N_muscle_untreated, arct_ris$trawling_depth,
                            arct_ris$size))
```

```{r}
#| echo: false
#| output: false
vegan::anova.cca(vegan::rda(arct_ris$d15N_muscle_untreated, arct_ris$size,
                            arct_ris$trawling_depth))
```

## Variance partitionning summary

```{r}
#| echo: false
#| fig-height: 7
#| fig-width: 13
#| label: var_part

variation_coeffcients <- utils::read.csv(here::here("data", "variation_coeffcients.csv"), sep = ";", header = T, dec = ",")

variation_coeffcients$species <- factor(variation_coeffcients$species,
                                        levels = c("Notoscopelus kroyeri",
                                                   "Searsia koefoedi",
                                                   "Community",
                                                   "Lampanyctus macdonaldi",
                                                   "Xenodermichthys copei",
                                                   "Arctozenus risso",
                                                   "Argyropelecus olfersii",
                                                   "Serrivomer beanii", 
                                                   "Melanostigma atlanticum",
                                                   "Myctophum punctatum",
                                                   "Lampanyctus crocodilus"))

# Percentage of variance for each variable + residuals 
var_freq <- variation_coeffcients %>%
  group_by(species) %>%
  mutate(freq = ((value*100)/sum(value)))

var_freq$relation <- factor(var_freq$relation,
                            levels=c("residuals","depth","depth_size","size"),
                            labels=c("Residuals","Depth only","Depth and size","Size only"))


# Stacked + percent
ggplot(var_freq , aes(fill=relation, y=freq, x=species)) + 
  geom_bar(position="stack", stat="identity", alpha=0.6, size=0.5, aes(col=relation))+
  scale_fill_manual(values = c("grey", "#33505C","#861D31","#D8973C"))+
  scale_colour_manual(values = c("grey", "#33505C","#861D31","#D8973C"))+
  theme_minimal()+
  coord_flip()+
  ylab("Pourcentage variance (%)")+
  theme(axis.text.y = element_text(face ="italic", size=16),
        axis.title = element_text(size=16),
        legend.text = element_text(size=16),
        legend.title = element_text(size=16),
        axis.text.x = element_text(size=16))+
  guides(fill=guide_legend(title="Explanatory variables"),
         color="none")
        
```

# 5. Summary table

**Testing significance:**

-   $\delta$<sup>15</sup>N - Size & $\delta$<sup>15</sup>N - depth : use of the anova.cca() function to test the significance of each part separately (depth & size) on the variability of $\delta$<sup>15</sup>N values
-   Depth - size : test with linear model lm (size\~depth)
-   *Stomias boa* & *Aphanopus carbo* \* depth range too small (\< 100m) so no use of variance partition models on these species, but linear models $\delta$<sup>15</sup>N - size significant

![Summary table](ontogeny_deep_pelagic_fish_files/figure-html/summary_table.jpg){width="70%"}

# 6. Limits

## Test of temporal variability on $\delta$<sup>15</sup>N values

-   Difficult to test because it is necessary to eliminate the biases due to size and depth.

-   However, over 90% of the sampling has been completed between 2019 and 2021 (and almost 3/4 in 2021)

-   If major environmental changes had occurred that significantly altered the baseline over time, this would have been observed in all species in the same way, which does not appear to be the case here

-   Test with *Lampnyctus crocodilus*: In the bathypelagic layer and individuals between 10 and 12cm : non signifiant differences

-   we can see that the data from the different years merge, there does not seem to be a strong effect of the year of sampling on the $\delta$<sup>15</sup>N values

 -   only night sampling

```{r}
#| echo: false
#| warning: false 
#| fig-height: 10
#| fig-width: 15
#| label: temporal_variability

ontogeny_data$years <- as.character(ontogeny_data$years)

ggplot(ontogeny_data , aes(x=size, y=d15N_muscle_untreated))+
  geom_point (alpha=0.7, aes(col=years), size=2.5) + 
  paletteer::scale_color_paletteer_d("ggsci::default_ucscgb")+
  facet_wrap(~species, scale="free_x")+ 
  xlab("Standard Length (cm)")+
  ylab(expression({delta}^15*N~'\u2030'))+
  theme_minimal()+
  theme(strip.text.x = element_text(size=18,face="italic"),
        axis.title = element_text(size=18),
        axis.text =  element_text(size=18),
        legend.title = element_text(size=18),
        legend.text = element_text(size=18))

```

## Representativeness of the sampling of individuals for $\delta$<sup>15</sup>N values

-   In supplementary material ?
-   no sampling of small *M. atlanticum* and big *L. macdonaldi*
-   but overall good sampling coverage over the size ranges of the species

```{r}
#| echo: false
#| warning: false 
#| fig-height: 10
#| fig-width: 15
#| label: data_set

ggplot(size_distribution_complete, aes(x=size)) +
  geom_density(alpha=0.3, linewidth=0.7, aes(col=dataset, fill= dataset))+
  scale_color_manual(values = c("#6FB668", "#A070FF"), labels = c("Isotopic data set", "Initial data set"))+
  scale_fill_manual(values = c("#6FB668", "#A070FF"), labels = c("Isotopic data set", "Initial data set"))+
  facet_wrap(~species, scale="free")+
  theme_minimal()+
  theme(strip.text.x = element_text(size=15,face="italic"),
        axis.title = element_text(size=22),
        axis.text =  element_text(size=15, color= "grey50"),
        panel.background=element_rect(color="white"),
        legend.title = element_text(size=20),
        legend.text = element_text(size=20))+
  xlab("Standard length (cm)")+
  guides(fill=guide_legend(title="Dataset"), col=guide_legend(title="Dataset"))
```

## Non-significant size-depth relationships at species level

```{r}
#| echo: false
#| warning: false 
#| fig-height: 10
#| fig-width: 16
#| label: size_depth_ns

# Selection of non-significant size-depth relationships
large_dataset_ns <- filter(large_dataset, species %in% c("Arctozenus risso", "Lampanyctus macdonaldi",
                                                         "Notoscopelus kroyeri", "Searsia koefoedi",
                                                         "Serrivomer beanii","Argyropelecus olfersii",
                                                         "Stomias boa", "Aphanopus carbo"))

large_dataset_ns$species <- factor(large_dataset_ns$species,
                            levels=c("Notoscopelus kroyeri", "Serrivomer beanii", 
                                     "Stomias boa","Argyropelecus olfersii",
                                     "Arctozenus risso", "Searsia koefoedi",
                                     "Aphanopus carbo", "Lampanyctus macdonaldi"),
                            labels = c("N. kroyeri", "S. beanii", 
                                     "S. boa","A. olfersii",
                                     "A. risso", "S. koefoedi",
                                     "A. carbo", "L.macdonaldi"))

# Density plot 
ggplot(large_dataset_ns, aes(x=size)) +
  geom_density(alpha=0.3, linewidth=0.8, adjust= 2, aes(fill= depth_layer, col= depth_layer))+
  geom_histogram(aes(y=..density.., fill= depth_layer, col= depth_layer), alpha=0.2, 
                 position="identity", binwidth = 1)+
  paletteer::scale_color_paletteer_d("jcolors::pal10")+
  paletteer::scale_fill_paletteer_d("jcolors::pal10")+
  facet_grid(depth_layer~species, scale="free")+
  theme_minimal()+
  theme(strip.text.x = element_text(size=20, face="italic"),
        strip.text.y = element_text(size=16),
        axis.title = element_text(size=19),
        axis.text =  element_text(size=16, color= "grey50"),
        panel.background=element_rect(color="white"),
        legend.title = element_text(size=19),
        legend.text = element_text(size=17))+
  guides(fill="none",col="none")+
  xlab("Standard Length (cm)")
```

